<div class="view-container h-full flex flex-col relative">
    <!-- Active Issues Banner -->
    <div x-data="issueBanner" x-show="issues.length > 0"
         class="flex-shrink-0 bg-space-900 border-b border-space-border/50 animate-fade-in z-20"
         style="display: none;">
        <div class="px-4 py-2">
            <div class="flex items-center justify-between">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2 py-1">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    Active Issues (<span x-text="issues.length"></span>)
                </h3>
                <button type="button" @click="expanded = !expanded" class="text-gray-500 hover:text-white transition-colors p-1">
                    <svg class="w-4 h-4 transition-transform duration-200" :class="{'rotate-180': !expanded}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                    </svg>
                </button>
            </div>
            <div class="space-y-2 mt-2 pb-2" x-show="expanded" x-cloak
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0">
                <template x-for="issue in issues" :key="issue.id">
                    <div class="flex items-start gap-3 p-3 rounded border text-xs" :class="getColorClass(issue.severity)">
                        <div class="mt-0.5 shrink-0" x-html="getIcon(issue.type)"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between gap-2">
                                <span class="font-bold truncate" x-text="issue.title"></span>
                                <span class="opacity-60 text-[10px]" x-text="new Date(issue.lastSeen).toLocaleTimeString()"></span>
                            </div>
                            <p class="opacity-80 mt-0.5" x-text="issue.description"></p>
                            <div class="flex items-center gap-2 mt-2" x-show="issue.suggestion">
                                <span class="opacity-60">Suggestion:</span>
                                <span class="font-medium" x-text="issue.suggestion"></span>
                            </div>
                        </div>
                        <button type="button" @click="resolveIssue(issue.id)"
                            class="shrink-0 px-2 py-1 rounded bg-black/20 hover:bg-black/40 transition-colors text-[10px] font-mono border border-current opacity-60 hover:opacity-100">
                            RESOLVE
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div x-data="logsViewer" class="flex flex-col flex-1 min-h-0">
        <!-- Toolbar -->
        <div class="bg-space-900 flex flex-wrap gap-y-2 justify-between items-center p-2 px-4 border-b border-space-border select-none min-h-[48px] shrink-0 relative z-30">
            <!-- Left: Decor & Title -->
            <div class="flex items-center gap-3 shrink-0">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
                </div>
                <span class="text-xs font-mono text-gray-500 hidden sm:inline-block">~/logs</span>
            </div>

            <!-- Center: Search & Filters -->
            <div class="flex-1 flex items-center justify-center gap-4 px-4 min-w-0">
                <!-- Search -->
                <div class="relative w-full max-w-xs group">
                    <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                        <svg class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" x-model="searchQuery" :placeholder="$store.global.t('grepLogs')"
                        class="w-full h-7 bg-space-950 border border-space-border rounded text-xs font-mono pl-7 pr-2 focus:border-neon-purple focus:outline-none transition-colors placeholder-gray-700 text-gray-300">
                </div>

                <!-- Quick Problems Toggle -->
                <button @click="toggleProblemOnly"
                    class="flex items-center gap-2 px-3 py-1 rounded text-[10px] font-mono transition-all border"
                    :class="onlyProblems ? 'bg-red-500/10 border-red-500/50 text-red-400 shadow-lg shadow-red-500/10' : 'bg-space-950 border-space-border text-gray-400 hover:border-red-500/30'">
                    <svg class="w-3 h-3" :class="onlyProblems ? 'animate-pulse' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span class="hidden md:inline">Problems Only</span>
                </button>

                <!-- Filters Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                        class="flex items-center gap-2 px-3 py-1 bg-space-950 border border-space-border rounded text-[10px] font-mono hover:border-neon-purple/50 transition-colors"
                        :class="{'border-neon-purple/50 bg-neon-purple/5': hasActiveFilters()}">
                        <span class="text-gray-400">Filters</span>
                        <span x-show="hasActiveFilters()" class="w-1.5 h-1.5 rounded-full bg-neon-purple animate-pulse"></span>
                        <svg class="w-3 h-3 text-gray-500" :class="{'rotate-180': open}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    <div x-show="open" @click.outside="open = false" @click.stop
                        class="absolute top-full left-1/2 -translate-x-1/2 mt-1 w-56 bg-space-900 border border-space-border rounded-lg shadow-xl z-50 p-3 space-y-3 animate-fade-in"
                        style="display: none;">

                        <!-- Quick Actions -->
                        <div class="flex items-center justify-between gap-2">
                            <span class="text-[9px] font-bold text-gray-600 uppercase">Quick</span>
                            <div class="flex gap-1">
                                <button type="button" @click="selectAllFilters()"
                                    class="px-2 py-0.5 text-[9px] font-mono bg-space-800 hover:bg-neon-green/20 text-gray-400 hover:text-neon-green rounded transition-colors">
                                    All
                                </button>
                                <button type="button" @click="selectNoFilters()"
                                    class="px-2 py-0.5 text-[9px] font-mono bg-space-800 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded transition-colors">
                                    None
                                </button>
                                <button type="button" @click="resetFilters()"
                                    class="px-2 py-0.5 text-[9px] font-mono bg-space-800 hover:bg-neon-purple/20 text-gray-400 hover:text-neon-purple rounded transition-colors">
                                    Reset
                                </button>
                            </div>
                        </div>

                        <div class="h-px bg-space-border/50"></div>

                        <!-- Severity -->
                        <div>
                            <div class="flex items-center justify-between mb-1.5">
                                <span class="text-[9px] font-bold text-gray-500 uppercase">Severity</span>
                                <button type="button" @click="toggleAllLevels()" class="text-[9px] text-gray-600 hover:text-gray-400">toggle</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.INFO ? 'bg-blue-500/10 text-blue-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.INFO">
                                    <span class="text-[10px] font-medium">INFO</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.SUCCESS ? 'bg-emerald-500/10 text-emerald-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.SUCCESS">
                                    <span class="text-[10px] font-medium">SUCCESS</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.WARN ? 'bg-yellow-500/10 text-yellow-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.WARN">
                                    <span class="text-[10px] font-medium">WARN</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.ERROR ? 'bg-red-500/10 text-red-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.ERROR">
                                    <span class="text-[10px] font-medium">ERROR</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.DEBUG ? 'bg-purple-500/10 text-purple-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.DEBUG">
                                    <span class="text-[10px] font-medium">DEBUG</span>
                                </label>
                            </div>
                        </div>

                        <div class="h-px bg-space-border/50"></div>

                        <!-- Event Types -->
                        <div>
                            <div class="flex items-center justify-between mb-1.5">
                                <span class="text-[9px] font-bold text-gray-500 uppercase">Event Type</span>
                                <button type="button" @click="toggleAllTypes()" class="text-[9px] text-gray-600 hover:text-gray-400">toggle</button>
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.request ? 'bg-gray-500/10 text-gray-300' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.request">
                                    <span class="text-[10px]">Requests</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.rate_limit ? 'bg-orange-500/10 text-orange-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.rate_limit">
                                    <span class="text-[10px]">Rate Limits</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.auth_failure ? 'bg-red-500/10 text-red-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.auth_failure">
                                    <span class="text-[10px]">Auth Failures</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.api_error ? 'bg-red-600/10 text-red-500' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.api_error">
                                    <span class="text-[10px]">API Errors</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.fallback ? 'bg-yellow-500/10 text-yellow-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.fallback">
                                    <span class="text-[10px]">Fallbacks</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.account_switch ? 'bg-cyan-500/10 text-cyan-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.account_switch">
                                    <span class="text-[10px]">Acc Switch</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors"
                                    :class="filters.health_change ? 'bg-pink-500/10 text-pink-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.health_change">
                                    <span class="text-[10px]">Health</span>
                                </label>
                                <label class="flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer transition-colors col-span-2"
                                    :class="filters.system ? 'bg-space-700 text-gray-400' : 'bg-space-800 text-gray-600 hover:text-gray-400'">
                                    <input type="checkbox" class="hidden" x-model="filters.system">
                                    <span class="text-[10px]">System Logs</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Shortcut -->
                <button @click="goToDashboard"
                    class="hidden sm:flex items-center gap-2 px-3 py-1 bg-space-950 border border-space-border rounded text-[10px] font-mono text-gray-400 hover:border-neon-green/50 hover:text-neon-green transition-colors">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span>View Stats</span>
                </button>
            </div>

            <!-- Right: Controls -->
            <div class="flex items-center gap-4 shrink-0">
                <div class="text-[10px] font-mono text-gray-600 hidden lg:block">
                    <span x-text="filteredLogs.length"></span>/<span x-text="logs.length"></span>
                </div>
                <label class="cursor-pointer flex items-center gap-2">
                    <span class="text-[10px] font-mono text-gray-500 uppercase hidden sm:inline-block"
                        x-text="$store.global.t('autoScroll')">Auto-Scroll</span>
                    <input type="checkbox" class="toggle toggle-xs toggle-success" x-model="isAutoScroll">
                </label>
                <button class="btn-action-ghost-square" @click="clearLogs" :title="$store.global.t('clearLogs')">
                     <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Summary Bar -->
        <div class="bg-space-950 border-b border-space-border/30 px-4 py-1.5 flex items-center gap-6 select-none relative z-20">
            <!-- Time Range Dropdown -->
            <div class="relative" x-data="{ open: false }">
                <button type="button" @click="open = !open"
                    title="Select time range for logs and statistics"
                    class="flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-widest transition-colors border"
                    :class="timeRange === '1h' ? 'bg-space-950 border-space-border text-gray-400 hover:border-neon-green/50' : 'bg-neon-green/10 border-neon-green/50 text-neon-green'">
                    <span x-text="timeRangeLabel"></span>
                    <svg class="w-3 h-3 opacity-60" :class="{'rotate-180': open}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div x-show="open" @click.outside="open = false" x-cloak
                    class="absolute top-full left-0 mt-1 bg-space-900 border border-space-border rounded shadow-xl z-50 py-1 min-w-[100px] animate-fade-in">
                    <template x-for="option in timeRangeOptions" :key="option.value">
                        <button type="button"
                            @click="timeRange = option.value; open = false"
                            class="w-full px-3 py-1.5 text-left text-[10px] font-mono transition-colors"
                            :class="timeRange === option.value ? 'bg-neon-green/10 text-neon-green' : 'text-gray-400 hover:bg-white/5 hover:text-white'">
                            <span x-text="option.label"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Active Issues -->
            <div class="flex items-center gap-2 cursor-pointer group" @click="showActiveIssues()">
                <div class="w-1.5 h-1.5 rounded-full" :class="summary.activeIssues > 0 ? 'bg-red-500 animate-pulse' : 'bg-gray-700'"></div>
                <span class="text-[10px] font-mono text-gray-400 group-hover:text-white transition-colors">
                    <span class="font-bold text-white" x-text="summary.activeIssues"></span> Active Issues
                </span>
            </div>

            <div class="w-px h-3 bg-space-border/50"></div>

            <!-- Rate Limits -->
            <div class="flex items-center gap-2 cursor-pointer group" @click="quickFilter('rate_limit')">
                <span class="text-[10px] font-mono text-gray-400 group-hover:text-orange-400 transition-colors">
                    ‚ö†Ô∏è <span class="font-bold text-white group-hover:text-orange-400" x-text="summary.rateLimits"></span> Rate Limits
                </span>
            </div>

            <!-- Auth Failures -->
            <div class="flex items-center gap-2 cursor-pointer group" @click="quickFilter('auth_failure')">
                <span class="text-[10px] font-mono text-gray-400 group-hover:text-red-400 transition-colors">
                    üîë <span class="font-bold text-white group-hover:text-red-400" x-text="summary.authFailures"></span> Auth Failures
                </span>
            </div>

            <!-- API Errors -->
            <div class="flex items-center gap-2 cursor-pointer group" @click="quickFilter('api_error')">
                <span class="text-[10px] font-mono text-gray-400 group-hover:text-red-500 transition-colors">
                    üí• <span class="font-bold text-white group-hover:text-red-500" x-text="summary.apiErrors"></span> API Errors
                </span>
            </div>

            <!-- Errors -->
            <div class="flex items-center gap-2 cursor-pointer group" @click="quickFilterLevel('ERROR')">
                <span class="text-[10px] font-mono text-gray-400 group-hover:text-red-500 transition-colors">
                    üö´ <span class="font-bold text-white group-hover:text-red-500" x-text="summary.errors"></span> Errors
                </span>
            </div>

            <!-- Help Hint -->
            <div class="ml-auto text-[9px] font-mono text-gray-600 hidden md:block">
                Click metrics to quick-filter
            </div>
        </div>

        <!-- Log Content -->
        <div id="logs-container" class="flex-1 overflow-auto p-4 font-mono text-[11px] leading-relaxed bg-space-950 custom-scrollbar">
            <template x-for="log in filteredLogs" :key="log._ui_id">
                <div class="group border-l-2 border-transparent hover:border-white/10 pl-2 -ml-2 mb-0.5"
                     :class="{
                        'bg-white/[0.02]': isExpanded(log),
                        'hover:bg-white/[0.03]': !isExpanded(log)
                     }">
                    <div class="flex gap-4 cursor-pointer" @click="toggleDetails(log)">
                        <!-- Timestamp -->
                        <span class="text-zinc-600 w-16 shrink-0 select-none group-hover:text-zinc-500 transition-colors"
                            x-text="new Date(log.timestamp).toLocaleTimeString([], {hour12:false})"></span>

                        <!-- Level & Type -->
                        <div class="w-24 shrink-0 flex items-center gap-2">
                            <!-- Level Badge -->
                            <span class="px-1.5 py-0.5 rounded-[2px] text-[9px] font-bold uppercase tracking-wider leading-none border w-10 text-center"
                                :class="{
                                    'bg-blue-500/10 text-blue-400 border-blue-500/20': log.level === 'INFO',
                                    'bg-yellow-500/10 text-yellow-400 border-yellow-500/20': log.level === 'WARN',
                                    'bg-red-500/10 text-red-500 border-red-500/20': log.level === 'ERROR',
                                    'bg-emerald-500/10 text-emerald-400 border-emerald-500/20': log.level === 'SUCCESS',
                                    'bg-purple-500/10 text-purple-400 border-purple-500/20': log.level === 'DEBUG'
                                }" x-text="log.level"></span>

                            <!-- Type Icon/Badge -->
                            <template x-if="log.type !== 'system' && log.type !== 'request'">
                                <span class="text-[9px] uppercase px-1 rounded text-gray-400 bg-space-800" x-text="log.type"></span>
                            </template>
                        </div>

                        <!-- Message -->
                        <div class="flex-1 min-w-0 flex items-start gap-2">
                            <span class="text-zinc-300 break-all group-hover:text-white transition-colors"
                                :class="{
                                    'text-red-400': log.level === 'ERROR',
                                    'text-yellow-400': log.level === 'WARN'
                                }"
                                x-html="(log.message || '').replace(/\n/g, '<br>')"></span>

                            <!-- Expand Hint (show if there's any expandable content) -->
                            <span x-show="(log.details && Object.keys(log.details).length > 0) || log.requestId || log.account || log.model"
                                  class="text-[9px] text-gray-600 group-hover:text-gray-400 shrink-0 mt-0.5">
                                <svg class="w-3 h-3 transition-transform" :class="{'rotate-90': isExpanded(log)}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </span>
                        </div>
                    </div>

                    <!-- Details Panel (only show if there's content to display) -->
                    <div x-show="isExpanded(log) && ((log.details && Object.keys(log.details).length > 0) || log.requestId || log.account || log.model)"
                         class="mt-2 ml-20 bg-black/30 rounded p-2 border border-white/5 overflow-x-auto" style="display: none;">
                        <pre x-show="log.details && Object.keys(log.details).length > 0" class="text-[10px] text-zinc-400" x-text="formatDetails(log.details)"></pre>

                        <!-- Context Info (only show if at least one field exists) -->
                        <div x-show="log.requestId || log.account || log.model"
                             class="flex gap-4 text-[10px] text-zinc-500"
                             :class="{'mt-2 pt-2 border-t border-white/5': log.details && Object.keys(log.details).length > 0}">
                            <span x-show="log.requestId">ReqID: <span class="text-zinc-400 select-all" x-text="log.requestId"></span></span>
                            <span x-show="log.account">Account: <span class="text-zinc-400 select-all" x-text="log.account"></span></span>
                            <span x-show="log.model">Model: <span class="text-zinc-400 select-all" x-text="log.model"></span></span>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Loading/Empty States -->
            <div class="h-3 w-1.5 bg-zinc-600 animate-pulse mt-1 inline-block" x-show="filteredLogs.length === logs.length && !searchQuery"></div>
            <div x-show="filteredLogs.length === 0 && logs.length > 0" class="text-zinc-700 italic mt-8 text-center"
                x-text="$store.global.t('noLogsMatch')">
                No logs match filter
            </div>
            <div x-show="logs.length === 0" class="text-zinc-800 italic mt-8 text-center">
                Waiting for events...
            </div>
        </div>
    </div>
</div>
