<div x-data="healthPage" class="view-container">
    <!-- Compact Header -->
    <div class="flex items-center justify-between gap-4 mb-6">
        <!-- Title with inline subtitle -->
        <div class="flex flex-wrap items-center gap-4">
            <h1 class="text-2xl font-bold text-white tracking-tight" x-text="$store.global.t('healthMonitoring')">
                Health Monitoring
            </h1>
            <div class="flex items-center h-6 px-3 rounded-full bg-space-800/80 border border-space-border/50 shadow-sm backdrop-blur-sm">
                <span class="text-[10px] font-mono text-gray-400 uppercase tracking-wider"
                      x-text="$store.global.t('healthMonitoringDesc')">
                    Account × Model Health Status
                </span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-3">
            <!-- Live Indicator -->
            <div class="hidden sm:flex items-center gap-2 px-2.5 py-1.5 rounded-lg bg-space-900/60 border border-space-border/40 whitespace-nowrap flex-shrink-0">
                <div class="relative flex items-center justify-center">
                    <span class="absolute w-1.5 h-1.5 bg-neon-green rounded-full animate-ping opacity-75"></span>
                    <span class="relative w-1.5 h-1.5 bg-neon-green rounded-full"></span>
                </div>
                <span class="text-[10px] font-mono text-gray-500 uppercase tracking-wider" x-text="$store.global.t('live')">Live</span>
                <span class="text-gray-700">•</span>
                <span class="text-[10px] font-mono text-gray-400 tabular-nums"
                      x-text="new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'})">
                </span>
            </div>

            <button class="btn btn-xs btn-outline border-space-border text-gray-400 hover:text-white transition-all gap-2 h-8"
                @click="loadMatrix()"
                :disabled="loading">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="w-3.5 h-3.5 transition-transform"
                     :class="{ 'animate-spin': loading }"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span x-text="$store.global.t('refresh')">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Health Summary Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 lg:gap-3 mb-6">
        <!-- Healthy -->
        <div @click="setFilter('healthy')"
             class="stat border rounded-xl p-3 lg:p-4 transition-all duration-300 group relative min-w-0 cursor-pointer"
             :class="activeFilter === 'healthy'
                ? 'bg-neon-green/10 border-neon-green/50 shadow-[0_0_15px_-3px_rgba(74,222,128,0.2)]'
                : 'bg-space-900/40 border-space-border/30 hover:border-neon-green/30 hover:bg-neon-green/5'">
            <div class="absolute top-3 right-3 transition-colors"
                 :class="activeFilter === 'healthy' ? 'text-neon-green' : 'text-gray-700/40 group-hover:text-neon-green/70'">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="stat-value text-white font-mono text-2xl lg:text-3xl font-bold mb-1 truncate" x-text="summary.healthy"></div>
            <div class="stat-title font-mono text-[10px] uppercase tracking-wider truncate"
                 :class="activeFilter === 'healthy' ? 'text-neon-green' : 'text-gray-500'"
                x-text="$store.global.t('healthyPairs')">Healthy</div>
            <div class="stat-desc text-neon-green/60 text-[10px] truncate" x-text="$store.global.t('healthScoreAbove90')">Score > 90%</div>
        </div>

        <!-- Warning -->
        <div @click="setFilter('warning')"
             class="stat border rounded-xl p-3 lg:p-4 transition-all duration-300 group relative min-w-0 cursor-pointer"
             :class="activeFilter === 'warning'
                ? 'bg-yellow-500/10 border-yellow-500/50 shadow-[0_0_15px_-3px_rgba(234,179,8,0.2)]'
                : 'bg-space-900/40 border-space-border/30 hover:border-yellow-500/30 hover:bg-yellow-500/5'">
            <div class="absolute top-3 right-3 transition-colors"
                 :class="activeFilter === 'warning' ? 'text-yellow-500' : 'text-gray-700/40 group-hover:text-yellow-500/70'">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="stat-value text-white font-mono text-2xl lg:text-3xl font-bold mb-1 truncate" x-text="summary.warning"></div>
            <div class="stat-title font-mono text-[10px] uppercase tracking-wider truncate"
                 :class="activeFilter === 'warning' ? 'text-yellow-500' : 'text-gray-500'"
                x-text="$store.global.t('warningPairs')">Warning</div>
            <div class="stat-desc text-yellow-500/60 text-[10px] truncate" x-text="$store.global.t('healthScoreDegraded')">70-90%</div>
        </div>

        <!-- Critical -->
        <div @click="setFilter('critical')"
             class="stat border rounded-xl p-3 lg:p-4 transition-all duration-300 group relative min-w-0 cursor-pointer"
             :class="activeFilter === 'critical'
                ? 'bg-red-500/10 border-red-500/50 shadow-[0_0_15px_-3px_rgba(239,68,68,0.2)]'
                : 'bg-space-900/40 border-space-border/30 hover:border-red-500/30 hover:bg-red-500/5'">
            <div class="absolute top-3 right-3 transition-colors"
                 :class="activeFilter === 'critical' ? 'text-red-500' : 'text-gray-700/40 group-hover:text-red-500/70'">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="stat-value text-white font-mono text-2xl lg:text-3xl font-bold mb-1 truncate" x-text="summary.critical"></div>
            <div class="stat-title font-mono text-[10px] uppercase tracking-wider truncate"
                 :class="activeFilter === 'critical' ? 'text-red-500' : 'text-gray-500'"
                x-text="$store.global.t('criticalPairs')">Critical</div>
            <div class="stat-desc text-red-500/60 text-[10px] truncate" x-text="$store.global.t('healthScoreLow')">< 70%</div>
        </div>

        <!-- Disabled -->
        <div @click="setFilter('disabled')"
             class="stat border rounded-xl p-3 lg:p-4 transition-all duration-300 group relative min-w-0 cursor-pointer"
             :class="activeFilter === 'disabled'
                ? 'bg-gray-500/10 border-gray-500/50 shadow-[0_0_15px_-3px_rgba(107,114,128,0.2)]'
                : 'bg-space-900/40 border-space-border/30 hover:border-gray-500/30 hover:bg-gray-500/5'">
            <div class="absolute top-3 right-3 transition-colors"
                 :class="activeFilter === 'disabled' ? 'text-gray-400' : 'text-gray-700/40 group-hover:text-gray-400/70'">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
            </div>
            <div class="stat-value text-white font-mono text-2xl lg:text-3xl font-bold mb-1 truncate" x-text="summary.disabled"></div>
            <div class="stat-title font-mono text-[10px] uppercase tracking-wider truncate"
                 :class="activeFilter === 'disabled' ? 'text-gray-400' : 'text-gray-500'"
                x-text="$store.global.t('disabledPairs')">Disabled</div>
            <div class="stat-desc text-gray-500/60 text-[10px] truncate" x-text="$store.global.t('autoOrManual')">Auto/Manual</div>
        </div>
    </div>

    <!-- Health Matrix -->
    <div class="view-card">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-neon-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-sm font-bold text-white tracking-wide uppercase" x-text="$store.global.t('healthMatrix')">Health Matrix</h3>
                <span class="text-[10px] text-gray-500 font-mono" x-show="!loading && matrix.length > 0" x-text="'(' + matrix.length + ' ' + $store.global.t('accounts').toLowerCase() + ')'"></span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Legend -->
                <div class="hidden sm:flex items-center gap-4 text-[10px] font-mono mr-4">
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded bg-neon-green/20 border border-neon-green/30"></div>
                        <span class="text-gray-500">> 90%</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded bg-yellow-500/20 border border-yellow-500/30"></div>
                        <span class="text-gray-500">70-90%</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded bg-red-500/20 border border-red-500/30"></div>
                        <span class="text-gray-500">< 70%</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded bg-gray-500/20 border border-gray-500/30"></div>
                        <span class="text-gray-500" x-text="$store.global.t('disabled')">Disabled</span>
                    </div>
                </div>
                <button @click="loadMatrix()" class="text-gray-500 hover:text-white transition-colors" :class="{'animate-spin': loading}" :title="$store.global.t('refresh')">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading && matrix.length === 0" class="flex justify-center py-12">
            <span class="loading loading-spinner loading-sm text-neon-green"></span>
        </div>

        <!-- Matrix Table -->
        <div x-show="!loading || matrix.length > 0" class="overflow-x-auto custom-scrollbar">
            <table class="standard-table">
                <thead>
                    <tr>
                        <th class="p-3 text-left text-gray-500 font-bold sticky left-0 bg-space-900 z-20 border-r border-space-border/30" x-text="$store.global.t('account')">Account</th>
                        <template x-for="model in commonModels" :key="model">
                            <th class="p-2 text-center text-gray-500 font-bold whitespace-nowrap min-w-[100px]">
                                <span x-text="model.replace('claude-', 'C-').replace('gemini-', 'G-').replace('-thinking', '')"></span>
                            </th>
                        </template>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(row, rowIndex) in matrix" :key="row.account">
                        <tr class="group" :class="{'opacity-40 grayscale': activeFilter && !row.models.some(m => activeFilter === 'all' || (m.disabled ? activeFilter === 'disabled' : (m.healthScore >= 90 ? activeFilter === 'healthy' : (m.healthScore >= 70 ? activeFilter === 'warning' : activeFilter === 'critical'))))}">
                            <td class="p-3 text-gray-400 font-medium truncate max-w-[180px] sticky left-0 bg-space-900 group-hover:bg-space-800 transition-colors z-10 border-r border-space-border/30 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.5)]"
                                x-text="row.account"
                                :title="row.account"></td>
                            <template x-for="(cell, cellIndex) in row.models" :key="cell.modelId">
                                <td class="p-1.5 text-center">
                                    <div @click="viewAccountHealth(row.account)"
                                         @mouseenter="showTooltip($event, cell)"
                                         @mousemove="updateTooltipPosition($event)"
                                         @mouseleave="hideTooltip()"
                                         class="w-full h-8 rounded flex items-center justify-center cursor-pointer border relative group/cell"
                                         :class="getHealthClass(cell)">
                                        <span class="font-bold text-[10px]" x-text="formatScore(cell.healthScore)"></span>
                                    </div>
                                </td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="matrix.length === 0 && !loading">
                        <td :colspan="commonModels.length + 1" class="p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-4">
                                <svg class="w-12 h-12 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="text-sm" x-text="$store.global.t('noHealthData')">No health data available yet</p>
                                <p class="text-xs text-gray-600" x-text="$store.global.t('noHealthDataDesc')">Health data will appear after accounts make API requests</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Global Floating Tooltip -->
    <div x-show="tooltip.show"
         class="fixed z-[9999] w-52 p-2.5 bg-space-900 border border-space-border/80 rounded-lg shadow-2xl pointer-events-none transition-opacity duration-150 backdrop-blur-md"
         :style="`left: ${tooltip.x}px; top: ${tooltip.y}px;`"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95">
        <div class="font-bold text-white text-xs mb-1.5 border-b border-space-border/50 pb-1 truncate" x-text="tooltip.modelId"></div>
        <div class="text-[10px] space-y-1.5">
            <div class="flex justify-between items-center">
                <span class="text-gray-500" x-text="$store.global.t('score') + ':'">Score:</span>
                <span class="font-mono font-bold" :class="tooltip.score >= 90 ? 'text-neon-green' : (tooltip.score >= 70 ? 'text-yellow-500' : 'text-red-400')" x-text="tooltip.score + '%'"></span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-500" x-text="$store.global.t('success') + ':'">Success:</span>
                <span class="text-neon-green font-mono" x-text="tooltip.success"></span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-500" x-text="$store.global.t('failures') + ':'">Failures:</span>
                <span class="text-red-400 font-mono" x-text="tooltip.failures"></span>
            </div>
            <div x-show="tooltip.quotaDisabled" class="pt-1 mt-1 border-t border-space-border/30">
                <div class="text-orange-500 font-bold flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    QUOTA LIMIT
                </div>
                <div x-show="tooltip.quotaResetTime" class="text-[9px] text-gray-500 mt-0.5" x-text="'Resets: ' + new Date(tooltip.quotaResetTime).toLocaleString()"></div>
            </div>
            <div x-show="tooltip.disabled && !tooltip.quotaDisabled" class="pt-1 mt-1 border-t border-space-border/30 text-red-500 font-bold flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                <span x-text="$store.global.t('disabled').toUpperCase()">DISABLED</span>
            </div>
        </div>
    </div>

    <!-- Active Issues Section -->
    <div class="view-card mt-6" x-show="issues.length > 0">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-sm font-bold text-white tracking-wide uppercase" x-text="$store.global.t('activeIssues')">Active Issues</h3>
                <span class="text-[10px] text-yellow-500 font-mono bg-yellow-500/10 px-2 py-0.5 rounded" x-text="issues.length"></span>
            </div>

            <!-- Issue Stats Mini-Dashboard -->
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 text-[10px] font-mono">
                    <div class="flex items-center gap-1.5">
                        <span class="text-gray-500" x-text="$store.global.t('resolved') || 'Resolved'">Resolved</span>
                        <span class="text-neon-green font-bold" x-text="issueStats.resolved || 0"></span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="text-gray-500" x-text="$store.global.t('acknowledged') || 'Acked'">Acked</span>
                        <span class="text-blue-400 font-bold" x-text="issueStats.acknowledged || 0"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-2">
            <template x-for="issue in issues" :key="issue.id">
                <div class="flex items-start gap-3 p-3 rounded-lg bg-space-800/50 border border-space-border/30 hover:border-yellow-500/30 transition-colors">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
                         :class="issue.severity === 'high' ? 'bg-red-500/10 text-red-500' : 'bg-yellow-500/10 text-yellow-500'">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-medium text-white truncate" x-text="issue.title"></span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded font-mono"
                                  :class="issue.severity === 'high' ? 'bg-red-500/10 text-red-400 border border-red-500/30' : 'bg-yellow-500/10 text-yellow-400 border border-yellow-500/30'"
                                  x-text="issue.severity.toUpperCase()"></span>
                        </div>
                        <p class="text-xs text-gray-500 truncate" x-text="issue.description"></p>
                        <p class="text-[10px] text-gray-600 mt-1" x-text="issue.suggestion"></p>
                    </div>
                    <button @click="resolveIssue(issue.id)"
                            class="btn btn-xs btn-ghost text-gray-500 hover:text-white"
                            :title="$store.global.t('resolve')">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>
